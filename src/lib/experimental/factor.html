<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../../polymer.html">
<script>
(function() {
  /* IGNORE FOR NOW
  const bindingRe = /^\[\[([a-z0-9]+)\]\]$/i;

  function parseBindings(root) {
    const bindings = {};

    if (root != null) {
      const attributes = root.attributes;

      for (let i = 0; i < attributes.length; ++i) {
        const match = bindingRe.exec(attributes[i].value);

        if (match != null) {
          const name = attributes[i].name;
          const property = match[1];
          const setAttribute = name.charAt(name.length - 1) === '$';

          root.removeAttribute(name);

          bindings[property] = bindings[property] || [];

          let binding;

          if (setAttribute) {
            const attributeName = name.substr(0, name.length - 1);
            binding = function(value) {
              root.setAttribute(attributeName, value);
            };
          } else {
            binding = function(value) {
              root[property] = value;
            };
          }
        }
      }
    }

    return bindings;
  }
  */

  function mapIdNodes(root) {
    if (root == null) {
      return;
    }

    const nodes = root.querySelectorAll('[id]');
    const map = {};

    for (var i = 0; i < nodes.length; ++i) {
      map[nodes[i].id] = nodes[i];
    }

    return map;
  }


  const factor = Polymer.Base.extend(Object.create(HTMLElement.prototype), {
		createdCallback: function() {
			this.__ready = false;
      this.__stylesheet = null;
      this.ownerRoot = null;

      this.root = this.__template
          ? Polymer.Base.instanceTemplate(this.__template)
          : null;

      // TODO(cdata): Take out this feature?
      this.$ = mapIdNodes(this.root);

      if (this.root != null) {
        this.appendChild(this.root);
      }

			if (this.created != null) {
				this.created();
			}
		},

		attachedCallback: function() {
			if (this.__ready === false) {
        let ownerRoot = this;

        while (ownerRoot && ownerRoot.nodeType !== Node.DOCUMENT_FRAGMENT_NODE) {
          ownerRoot = ownerRoot.parentNode;
        }

        const styleParent = this.ownerRoot != null
            ? this.ownerRoot
            : this.ownerDocument.head;

        if (!this.__styledRoots.has(styleParent)) {
          const stylesheet = document.createElement('style');

          stylesheet.textContent = this.__cssText;
          styleParent.appendChild(stylesheet);

          this.__styledRoots.add(styleParent);
        }

				this.__ready = true;

				if (this.ready != null) {
					this.ready();
				}
			}

			if (this.detached != null) {
				this.detached();
			}
		},

		detachedCallback: function() {
			if (this.detached != null) {
				this.detached();
			}
    }
  });


	Polymer.Factor = function(implementation) {
    const proto = Object.create(factor);
    const module = Polymer.DomModule.import(implementation.is);

    Polymer.Base.extend(proto, implementation);

    if (module != null) {
      const template = module.querySelector('template');

      if (template != null) {
        const stylesheet =
            (template._content || template.content).querySelector('style');

        proto.__styledRoots = new WeakSet();
        proto.__template = template;
        proto.__cssText = stylesheet ? stylesheet.textContent : '';

        stylesheet.parentNode.removeChild(stylesheet);
      }
    }

    document.registerElement(proto.is, {
			prototype: proto
		});
	};
})();
</script>
