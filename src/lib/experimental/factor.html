<!--
  @license
  Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
  This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
  The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
  The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
  Code distributed by Google as part of the polymer project is also
  subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../../polymer.html">
<link rel="import" href="property-accessors.html">
<script>
(function() {

  function mapIdNodes(root) {
    if (root == null) {
      return;
    }

    const nodes = root.querySelectorAll('[id]');
    const map = {};

    for (var i = 0; i < nodes.length; ++i) {
      map[nodes[i].id] = nodes[i];
    }

    return map;
  }


  const base = Polymer.Base.extend(
      Object.create(HTMLElement.prototype),
      Polymer.PropertyAccessors.mixin);

  const factor = Polymer.Base.extend(base, {
    createdCallback: function() {
      this.__ready = false;

      this.root = this.__template
          ? Polymer.Base.instanceTemplate(this.__template)
          : null;

      // TODO(cdata): Take out this feature?
      this.$ = mapIdNodes(this.root);

      this._initializeProperties();

      if (this.root != null) {
        Polymer.dom(this).appendChild(this.root);
      }

      if (this.created != null) {
        this.created();
      }
    },

    attachedCallback: function() {
      if (this.__ready === false) {
        var ownerRoot = this;

        while (ownerRoot
               && ownerRoot.nodeType !== Node.DOCUMENT_FRAGMENT_NODE) {
          ownerRoot = ownerRoot.parentNode;
        }

        const styleParent = ownerRoot != null
          ? ownerRoot
          : this.ownerDocument.head;

        if (!this.__styledRoots.has(styleParent)) {
          const stylesheet = document.createElement('style');

          stylesheet.textContent = this.__cssText;
          styleParent.appendChild(stylesheet);

          this.__styledRoots.add(styleParent);
        }

        this.__ready = true;

        if (this.ready != null) {
          this.ready();
        }
      }

      if (this.detached != null) {
        this.detached();
      }
    },

    detachedCallback: function() {
      if (this.detached != null) {
        this.detached();
      }
    }
  });


  Polymer.Factor = function(implementation) {
    const proto = Object.create(factor);
    const is = implementation.is;
    const properties = implementation.properties;
    const module = Polymer.DomModule.import(is);

    Polymer.Base.extend(proto, implementation);

    for (var property in properties) {
      const value = properties[property];
      proto[property] = value;
      proto._createPropertyAccessor(property);
    }

    if (module != null) {
      const template = module.querySelector('template');

      if (template != null) {
        const stylesheet =
            (template._content || template.content).querySelector('style');

        proto.__styledRoots = new WeakSet();
        proto.__template = template;
        proto.__cssText = stylesheet ? stylesheet.textContent : '';

        stylesheet.parentNode.removeChild(stylesheet);
      }
    }

    document.registerElement(is, {
      prototype: proto
    });
  };
})();
</script>
