<!DOCTYPE html>
<html>
<head>
  <script src="../../../webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../polymer.html">
</head>
<body>
<script>
  var DirtyCheck = function(base) {
    return class extends base {

      // _shouldPropChange(property, value, old) {
      //   return Polymer.forceSet ?
      //     super._shouldPropChange(property, value, old) :
      //     value !== old;
      // }

      // _setPropertyFromNotification(path, value, event) {
      //   if (Polymer.forceSet &&
      //       (typeof value == 'object') &&
      //       (Polymer.Path.root(path) == path)) {
      //     console.warn('avoid notification when force setting.');
      //   } else {
      //     super._setPropertyFromNotification(path, value, event);
      //   }
      // }

      // forceSet(name) {
      //   Polymer.forceSet = true;
      //   this.set(name, this.get(name));
      //   Polymer.forceSet = false;
      // }
    }
  }
</script>

<dom-module id="x-child">
  <template>
    {{json(stuff)}}
  </template>
  <script>
    class XChild extends DirtyCheck(Polymer.Element) {
      static get is() {return 'x-child'}
      static get config() {
        return {
          properties: {
            stuff: {
              type: Object,
              computed: '_compute(input)',
              notify: true
            }
          }
        }
      }

      _compute(v) {
        console.log(this.localName, '_compute', v);
        return v;
      }
      json(v) {
        return JSON.stringify(v);
      }
    }
    customElements.define(XChild.is, XChild);
  </script>
</dom-module>

<dom-module id="x-host">
  <template>
    <x-child id="child" input="{{input}}" stuff="{{stuff}}"></x-child>
  </template>
  <script>
    class XHost extends DirtyCheck(Polymer.Element) {
      static get is() {return 'x-host'}
      static get config() {
        return {
          properties: {
            input: {
              type: Object,
              computed: '_compute(stuff)',
              notify: true
            },
            stuff: {
              value: function() { return {a: true}}
            }
          }
        }
      }

      _compute(v) {
        console.log(this.localName, '_compute', v);
        return v;
      }
    }
    customElements.define(XHost.is, XHost);
  </script>
</dom-module>

<x-host id="host"></x-host>
<button id="xhostbutton">forceSet x-host</button>

<button id="xchildbutton">forceSet x-child</button>

<script>
  var i = 0;
  xhostbutton.addEventListener('click', function(e) {
    host.stuff[++i] = true;
    host.forceSet('stuff');
  });
  xchildbutton.addEventListener('click', function(e) {
    host.$.child.stuff[++i] = true;
    host.$.child.forceSet('stuff');
  })
</script>

</body>
</html>
